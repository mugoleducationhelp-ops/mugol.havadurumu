<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0a0e27">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="MuGÃ¶l Hava">
    <meta name="description" content="MuGÃ¶l Portal Hava Durumu">
    <title>MuGÃ¶l Hava Durumu</title>
    <style>
        /* [Ã–nceki stiller aynÄ± kalacak - kÄ±saltÄ±ldÄ±] */
        :root{--bg-primary:#0a0e27;--bg-secondary:#1a1f3a;--card-bg:rgba(30,41,82,.7);--card-border:rgba(255,255,255,.1);--text-primary:#fff;--text-secondary:rgba(255,255,255,.8);--text-tertiary:rgba(255,255,255,.6);--accent-primary:#3b82f6;--accent-gradient:linear-gradient(135deg,#3b82f6 0%,#60a5fa 100%);--success:#10b981;--shadow-md:0 8px 24px rgba(0,0,0,.25)}body{margin:0;font-family:'Inter',sans-serif;background:linear-gradient(180deg,var(--bg-primary) 0%,var(--bg-secondary) 100%);min-height:100vh;color:var(--text-primary)}body.light-mode{--bg-primary:#f8fafc;--bg-secondary:#e2e8f0;--card-bg:rgba(255,255,255,.9);--card-border:rgba(0,0,0,.06);--text-primary:#0f172a;--text-secondary:rgba(15,23,42,.7);--text-tertiary:rgba(15,23,42,.5)}.container{max-width:680px;margin:0 auto;padding:20px 16px}.header{display:flex;align-items:center;justify-content:space-between;padding:12px 8px;margin-bottom:24px}.logo{width:60px;height:60px;border-radius:50%}.header-title{font-family:'Outfit',sans-serif;font-size:1.5rem;font-weight:700}.location-btn,.theme-toggle{width:48px;height:48px;background:var(--card-bg);border:1px solid var(--card-border);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px;cursor:pointer}.search-card,.weather-card{background:var(--card-bg);border:1px solid var(--card-border);border-radius:20px;padding:20px;margin-bottom:20px;box-shadow:var(--shadow-md)}.city-select{flex:1;background:rgba(255,255,255,.05);border:1px solid var(--card-border);border-radius:12px;padding:14px;color:var(--text-primary);font-size:15px}.search-btn,.refresh-btn{width:52px;height:52px;background:var(--accent-gradient);border:none;border-radius:14px;color:#fff;font-size:20px;cursor:pointer}.detail-row{display:flex;align-items:center;justify-content:space-between;padding:16px;background:rgba(255,255,255,.03);border-radius:14px}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <div class="logo"><img src="logo.png" alt="Logo"></div>
                <div class="header-title">MuGÃ¶l Hava</div>
            </div>
            <div class="header-actions">
                <div class="location-btn" id="notificationBtn" title="Bildirim">ğŸ””</div>
                <div class="location-btn" id="locationBtn" title="Konum">ğŸ“</div>
                <div class="theme-toggle" id="themeToggle">ğŸŒ™</div>
            </div>
        </div>

        <div class="search-card">
            <div class="search-content">
                <select class="city-select" id="citySelect">
                    <option value="">Åehir SeÃ§in</option>
                    <!-- [TÃ¼m ÅŸehirler aynÄ± kalacak] -->
                    <option value="Adana">Adana</option>
                    <option value="AdÄ±yaman">AdÄ±yaman</option>
                    <option value="Afyonkarahisar">Afyonkarahisar</option>
                    <option value="AÄŸrÄ±">AÄŸrÄ±</option>
                    <option value="Aksaray">Aksaray</option>
                    <option value="Amasya">Amasya</option>
                    <option value="Ankara">Ankara</option>
                    <option value="Antalya">Antalya</option>
                    <option value="Ardahan">Ardahan</option>
                    <option value="Artvin">Artvin</option>
                    <option value="AydÄ±n">AydÄ±n</option>
                    <option value="BalÄ±kesir">BalÄ±kesir</option>
                    <option value="BartÄ±n">BartÄ±n</option>
                    <option value="Batman">Batman</option>
                    <option value="Bayburt">Bayburt</option>
                    <option value="Bilecik">Bilecik</option>
                    <option value="BingÃ¶l">BingÃ¶l</option>
                    <option value="Bitlis">Bitlis</option>
                    <option value="Bolu">Bolu</option>
                    <option value="Burdur">Burdur</option>
                    <option value="Bursa">Bursa</option>
                    <option value="Ã‡anakkale">Ã‡anakkale</option>
                    <option value="Ã‡ankÄ±rÄ±">Ã‡ankÄ±rÄ±</option>
                    <option value="Ã‡orum">Ã‡orum</option>
                    <option value="Denizli">Denizli</option>
                    <option value="DiyarbakÄ±r">DiyarbakÄ±r</option>
                    <option value="DÃ¼zce">DÃ¼zce</option>
                    <option value="Edirne">Edirne</option>
                    <option value="ElazÄ±ÄŸ">ElazÄ±ÄŸ</option>
                    <option value="Erzincan">Erzincan</option>
                    <option value="Erzurum">Erzurum</option>
                    <option value="EskiÅŸehir">EskiÅŸehir</option>
                    <option value="Gaziantep">Gaziantep</option>
                    <option value="Giresun">Giresun</option>
                    <option value="GÃ¼mÃ¼ÅŸhane">GÃ¼mÃ¼ÅŸhane</option>
                    <option value="Hakkari">Hakkari</option>
                    <option value="Hatay">Hatay</option>
                    <option value="IÄŸdÄ±r">IÄŸdÄ±r</option>
                    <option value="Isparta">Isparta</option>
                    <option value="Ä°stanbul">Ä°stanbul</option>
                    <option value="Ä°zmir">Ä°zmir</option>
                    <option value="KahramanmaraÅŸ">KahramanmaraÅŸ</option>
                    <option value="KarabÃ¼k">KarabÃ¼k</option>
                    <option value="Karaman">Karaman</option>
                    <option value="Kars">Kars</option>
                    <option value="Kastamonu">Kastamonu</option>
                    <option value="Kayseri">Kayseri</option>
                    <option value="Kilis">Kilis</option>
                    <option value="KÄ±rÄ±kkale">KÄ±rÄ±kkale</option>
                    <option value="KÄ±rklareli">KÄ±rklareli</option>
                    <option value="KÄ±rÅŸehir">KÄ±rÅŸehir</option>
                    <option value="Kocaeli">Kocaeli</option>
                    <option value="Konya">Konya</option>
                    <option value="KÃ¼tahya">KÃ¼tahya</option>
                    <option value="Malatya">Malatya</option>
                    <option value="Manisa">Manisa</option>
                    <option value="Mardin">Mardin</option>
                    <option value="Mersin">Mersin</option>
                    <option value="MuÄŸla">MuÄŸla</option>
                    <option value="MuÅŸ">MuÅŸ</option>
                    <option value="NevÅŸehir">NevÅŸehir</option>
                    <option value="NiÄŸde">NiÄŸde</option>
                    <option value="Ordu">Ordu</option>
                    <option value="Osmaniye">Osmaniye</option>
                    <option value="Rize">Rize</option>
                    <option value="Sakarya">Sakarya</option>
                    <option value="Samsun">Samsun</option>
                    <option value="ÅanlÄ±urfa">ÅanlÄ±urfa</option>
                    <option value="Siirt">Siirt</option>
                    <option value="Sinop">Sinop</option>
                    <option value="ÅÄ±rnak">ÅÄ±rnak</option>
                    <option value="Sivas">Sivas</option>
                    <option value="TekirdaÄŸ">TekirdaÄŸ</option>
                    <option value="Tokat">Tokat</option>
                    <option value="Trabzon">Trabzon</option>
                    <option value="Tunceli">Tunceli</option>
                    <option value="UÅŸak">UÅŸak</option>
                    <option value="Van">Van</option>
                    <option value="Yalova">Yalova</option>
                    <option value="Yozgat">Yozgat</option>
                    <option value="Zonguldak">Zonguldak</option>
                </select>
                <button class="search-btn" id="searchBtn">ğŸ”</button>
                <button class="refresh-btn" id="refreshBtn">ğŸ”„</button>
            </div>
        </div>

        <div class="weather-card">
            <div class="weather-content" id="weatherContent">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>YÃ¼kleniyor...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_KEY = '5689ce426e3668ec41daf1d9d3600832';
        const cityCoords = { /* [Åehir koordinatlarÄ± aynÄ± kalacak] */
            "Adana":[37,35.3213],"AdÄ±yaman":[37.7648,38.2786],"Afyonkarahisar":[38.7507,30.5567],"AÄŸrÄ±":[39.7191,43.0503],"Aksaray":[38.3687,34.0370],"Amasya":[40.6499,35.8353],"Ankara":[39.9334,32.8597],"Antalya":[36.8969,30.7133],"Ardahan":[41.1105,42.7022],"Artvin":[41.1828,41.8183],"AydÄ±n":[37.8560,27.8416],"BalÄ±kesir":[39.6484,27.8826],"BartÄ±n":[41.5811,32.4610],"Batman":[37.8812,41.1351],"Bayburt":[40.2552,40.2249],"Bilecik":[40.0567,30.0665],"BingÃ¶l":[39.0626,40.7696],"Bitlis":[38.3938,42.1232],"Bolu":[40.5760,31.5788],"Burdur":[37.4613,30.0665],"Bursa":[40.1826,29.0665],"Ã‡anakkale":[40.1553,26.4142],"Ã‡ankÄ±rÄ±":[40.6013,33.6134],"Ã‡orum":[40.5506,34.9556],"Denizli":[37.7765,29.0864],"DiyarbakÄ±r":[37.9144,40.2306],"DÃ¼zce":[40.8438,31.1565],"Edirne":[41.6771,26.5557],"ElazÄ±ÄŸ":[38.6810,39.2264],"Erzincan":[39.75,39.49],"Erzurum":[39.9,41.27],"EskiÅŸehir":[39.7767,30.5206],"Gaziantep":[37.0662,37.3833],"Giresun":[40.9128,38.3895],"GÃ¼mÃ¼ÅŸhane":[40.4386,39.5086],"Hakkari":[37.5744,43.7408],"Hatay":[36.4018,36.3498],"IÄŸdÄ±r":[39.8880,44.0048],"Isparta":[37.7648,30.5566],"Ä°stanbul":[41.0082,28.9784],"Ä°zmir":[38.4192,27.1287],"KahramanmaraÅŸ":[37.5858,36.9371],"KarabÃ¼k":[41.2061,32.6204],"Karaman":[37.1759,33.2287],"Kars":[40.6167,43.0975],"Kastamonu":[41.3887,33.7827],"Kayseri":[38.7312,35.4787],"Kilis":[36.7184,37.1212],"KÄ±rÄ±kkale":[39.8468,33.5153],"KÄ±rklareli":[41.7333,27.2167],"KÄ±rÅŸehir":[39.1425,34.1709],"Kocaeli":[40.8533,29.8815],"Konya":[37.8746,32.4932],"KÃ¼tahya":[39.4242,29.9833],"Malatya":[38.3552,38.3095],"Manisa":[38.6191,27.4289],"Mardin":[37.3212,40.7245],"Mersin":[36.8121,34.6415],"MuÄŸla":[37.2153,28.3636],"MuÅŸ":[38.9462,41.7539],"NevÅŸehir":[38.6939,34.6857],"NiÄŸde":[37.9667,34.6833],"Ordu":[40.9839,37.8764],"Osmaniye":[37.2130,36.1763],"Rize":[41.0201,40.5234],"Sakarya":[40.7569,30.3781],"Samsun":[41.2867,36.33],"ÅanlÄ±urfa":[37.1591,38.7969],"Siirt":[37.9333,41.95],"Sinop":[42.0231,35.1531],"ÅÄ±rnak":[37.4187,42.4918],"Sivas":[39.7477,37.0179],"TekirdaÄŸ":[40.9833,27.5167],"Tokat":[40.3167,36.55],"Trabzon":[41.0015,39.7178],"Tunceli":[39.3074,39.4388],"UÅŸak":[38.6823,29.4082],"Van":[38.4891,43.4089],"Yalova":[40.65,29.2667],"Yozgat":[39.8181,34.8147],"Zonguldak":[41.4564,31.7987]
        };

        let swReg = null, swReady = false, isLocation = false, lat = null, lon = null;

        async function fetchWeather(lat, lon, cityName) {
            const [cur, fc] = await Promise.all([
                fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${API_KEY}&units=metric&lang=tr`),
                fetch(`https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&appid=${API_KEY}&units=metric&lang=tr`)
            ]);
            const curData = await cur.json(), fcData = await fc.json();
            const mapCode = id => id>=200&&id<300?95:id>=300&&id<400?51:id>=500&&id<600?61:id>=600&&id<700?71:id>=700&&id<800?45:id===800?0:id===801?1:id===802?2:3;
            const city = cityName || (await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&accept-language=tr&zoom=18`,{headers:{'User-Agent':'MuGol-Hava'}}).then(r=>r.json()).then(d=>d.address.city||d.address.town||d.address.village||'Konum').catch(()=>'Konum'));
            return {city, data:{
                current:{temp:curData.main.temp, humidity:curData.main.humidity, code:mapCode(curData.weather[0].id), wind:curData.wind.speed*3.6, pressure:curData.main.pressure},
                hourly:{time:fcData.list.map(i=>i.dt_txt), temp:fcData.list.map(i=>i.main.temp), code:fcData.list.map(i=>mapCode(i.weather[0].id))},
                daily:{time:[],max:[],min:[],code:[]}
            }};
        }

        async function displayWeather({city,data}) {
            const icons = {0:'â˜€ï¸',1:'â›…',2:'â›…',3:'â˜ï¸',45:'ğŸŒ«ï¸',51:'ğŸŒ¦ï¸',61:'ğŸŒ§ï¸',71:'â„ï¸',95:'â›ˆï¸'};
            const descs = {0:'AÃ§Ä±k',1:'Az Bulutlu',2:'ParÃ§alÄ± Bulutlu',3:'Bulutlu',45:'Sisli',51:'Ã‡isenti',61:'YaÄŸmurlu',71:'KarlÄ±',95:'FÄ±rtÄ±nalÄ±'};
            const current = data.current, hourly = data.hourly, daily = data.daily;
            
            // GÃ¼nlÃ¼k verileri hesapla
            const dailyMap = {};
            fcData.list.forEach(item => {
                const date = item.dt_txt.split(' ')[0];
                if (!dailyMap[date]) dailyMap[date] = {temps:[], codes:[]};
                dailyMap[date].temps.push(item.main.temp);
                dailyMap[date].codes.push(mapCode(item.weather[0].id));
            });
            Object.keys(dailyMap).slice(0,5).forEach(date => {
                daily.time.push(date);
                daily.max.push(Math.max(...dailyMap[date].temps));
                daily.min.push(Math.min(...dailyMap[date].temps));
                daily.code.push(dailyMap[date].codes[0]);
            });

            const hourlyData = [0,3,6,9,12,15,18,21,24].map(slot => {
                const target = new Date(); target.setHours(slot === 24 ? 0 : slot, 0, 0, 0);
                if (slot === 24) target.setDate(target.getDate() + 1);
                const closest = hourly.time.reduce((best,time,i) => {
                    const diff = Math.abs(new Date(time) - target);
                    return diff < best.diff ? {i,diff} : best;
                }, {i:-1,diff:Infinity});
                return closest.i !== -1 ? {time:`${String(slot).padStart(2,'0')}:00`, temp:Math.round(hourly.temp[closest.i]), icon:icons[hourly.code[closest.i]]} : null;
            }).filter(Boolean);

            const dailyData = Array.from({length:5},(_,i)=>({
                date:new Date(daily.time[i]).toLocaleDateString('tr',{weekday:'short',day:'numeric',month:'short'}),
                max:Math.round(daily.max[i]), min:Math.round(daily.min[i]), icon:icons[daily.code[i]]
            }));

            document.getElementById('weatherContent').innerHTML = `
                <div class="main-weather">
                    <div class="weather-icon-large">${icons[current.code]}</div>
                    <div class="temperature-large">${Math.round(current.temp)}Â°C</div>
                    <div class="weather-desc">${descs[current.code]}</div>
                    <div class="location-text"><span>ğŸ“</span><span>${city}</span></div>
                </div>
                <div class="details-container">
                    <div class="detail-row"><div class="detail-left"><span class="detail-icon">ğŸ’§</span><span class="detail-label">Nem:</span></div><span class="detail-value">${current.humidity}%</span></div>
                    <div class="detail-row"><div class="detail-left"><span class="detail-icon">ğŸ’¨</span><span class="detail-label">RÃ¼zgar:</span></div><span class="detail-value">${Math.round(current.wind)} km/h</span></div>
                    <div class="detail-row"><div class="detail-left"><span class="detail-icon">ğŸŒ¡ï¸</span><span class="detail-label">BasÄ±nÃ§:</span></div><span class="detail-value">${Math.round(current.pressure)} hPa</span></div>
                </div>
                <div style="margin-bottom:24px"><div class="section-title"><span>ğŸ•</span><span>Saatlik Tahmin</span></div><div class="hourly-scroll">${hourlyData.map(h=>`<div class="hourly-item"><div class="hourly-time">${h.time}</div><div class="hourly-icon">${h.icon}</div><div class="hourly-temp">${h.temp}Â°C</div></div>`).join('')}</div></div>
                <div style="margin-bottom:16px"><div class="section-title"><span>ğŸ“…</span><span>5 GÃ¼nlÃ¼k Tahmin</span></div>${dailyData.map(d=>`<div class="daily-item"><div class="daily-day">${d.date}</div><div class="daily-icon">${d.icon}</div><div class="daily-temps"><span class="temp-max">${d.max}Â°</span><span class="temp-min">${d.min}Â°</span></div></div>`).join('')}</div>
                <div class="weather-source">Kaynak: OpenWeatherMap</div>
            `;
        }

        async function registerSW() {
            if (!('serviceWorker' in navigator)) throw new Error('SW desteklenmiyor');
            const reg = await navigator.serviceWorker.register('/sw.js', {scope:'/'});
            await new Promise((resolve, reject) => {
                const timeout = setTimeout(() => reject('SW timeout'), 10000);
                if (reg.installing) {
                    reg.installing.addEventListener('statechange', e => {
                        if (e.target.state === 'activated') { clearTimeout(timeout); resolve(); }
                    });
                } else resolve();
            });
            swReg = reg; swReady = true;
            return reg;
        }

        document.getElementById('notificationBtn').addEventListener('click', async () => {
            if (!('Notification' in window)) { alert('âŒ Bildirim desteklenmiyor'); return; }
            
            if (Notification.permission === 'granted') {
                if (notificationBtn.classList.contains('active')) {
                    notificationBtn.classList.remove('active');
                    if (swReg?.active) swReg.active.postMessage({type:'CLOSE_NOTIFICATION'});
                    alert('âœ… Bildirimler kapatÄ±ldÄ±');
                } else {
                    // Service Worker yoksa kaydet
                    if (!swReady) {
                        try { await registerSW(); }
                        catch(e) { alert('âŒ Service Worker kaydedilemedi. URL: ' + window.location.href); return; }
                    }
                    notificationBtn.classList.add('active');
                    // Bildirim gÃ¶ster
                    const city = document.querySelector('.location-text span:last-child')?.textContent || 'Ä°stanbul';
                    const [cityLat,cityLon] = cityCoords[city] || cityCoords['Ä°stanbul'];
                    const weather = await fetchWeather(cityLat, cityLon, city);
                    swReg.active.postMessage({type:'SHOW_WEATHER_NOTIFICATION', data:{
                        city:weather.city, temp:Math.round(weather.data.current.temp), 
                        desc:{0:'AÃ§Ä±k',1:'Az Bulutlu',2:'ParÃ§alÄ± Bulutlu',3:'Bulutlu',45:'Sisli',51:'Ã‡isenti',61:'YaÄŸmurlu',71:'KarlÄ±',95:'FÄ±rtÄ±nalÄ±'}[weather.data.current.code],
                        icon:{0:'â˜€ï¸',1:'â›…',2:'â›…',3:'â˜ï¸',45:'ğŸŒ«ï¸',51:'ğŸŒ¦ï¸',61:'ğŸŒ§ï¸',71:'â„ï¸',95:'â›ˆï¸'}[weather.data.current.code],
                        humidity:weather.data.current.humidity, wind:Math.round(weather.data.current.wind)
                    }});
                }
            } else if (Notification.permission === 'denied') {
                alert('âŒ Bildirim izni reddedilmiÅŸ. TarayÄ±cÄ± ayarlarÄ±ndan izin verin.');
            } else {
                const perm = await Notification.requestPermission();
                if (perm === 'granted') {
                    if (!swReady) {
                        try { await registerSW(); }
                        catch(e) { alert('âŒ Service Worker kaydedilemedi'); return; }
                    }
                    notificationBtn.classList.add('active');
                }
            }
        });

        // Otomatik SW kaydÄ±
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => registerSW().catch(e => console.error('SW auto-register failed', e)));
        }

        // DiÄŸer event listener'lar
        document.getElementById('searchBtn').addEventListener('click', async () => {
            const city = document.getElementById('citySelect').value;
            if (!city) return alert('Åehir seÃ§in');
            const [lat,lon] = cityCoords[city];
            const weather = await fetchWeather(lat, lon, city);
            displayWeather(weather);
        });

        document.getElementById('refreshBtn').addEventListener('click', async () => {
            const city = document.querySelector('.location-text span:last-child')?.textContent || 'Ä°stanbul';
            const [lat,lon] = cityCoords[city];
            const weather = await fetchWeather(lat, lon, city);
            displayWeather(weather);
        });

        // Ä°lk yÃ¼kleme
        (async () => {
            const [lat,lon] = cityCoords['Ä°stanbul'];
            const weather = await fetchWeather(lat, lon, 'Ä°stanbul');
            displayWeather(weather);
        })();
    </script>
</body>
</html> 
